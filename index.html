<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ESP32 BLE Test</title>
</head>
<body>
  <h2>ESP32 BLE コード送信テスト</h2>
  
  <button id="connect">ESP32に接続</button><br><br>
  <input type="text" id="code" placeholder="例: 60,64,67">
  <button id="send">送信</button>

  <p id="status">未接続</p>

<script>
let esp32Device;
let esp32Characteristic;

const SERVICE_UUID = "AB345678-1234-5678-1234-56789ABCDEF0";
const CHARACTERISTIC_UUID = "AB345678-1234-5678-1234-56789ABCDEF1";

document.getElementById('connect').onclick = async () => {
  try {
    document.getElementById('status').innerText = "スキャン中...";
    esp32Device = await navigator.bluetooth.requestDevice({
      filters: [{services: [SERVICE_UUID]}]
    });

    const server = await esp32Device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    esp32Characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

    document.getElementById('status').innerText = "接続成功!";
    console.log("Connected to ESP32");
  } catch (error) {
    console.log(error);
    document.getElementById('status').innerText = "接続失敗";
  }
};

document.getElementById('send').onclick = async () => {
  if (!esp32Characteristic) {
    alert("まず接続してください");
    return;
  }

  const codeStr = document.getElementById('code').value;
  if (!codeStr) {
    alert("コードを入力してください");
    return;
  }

  try {
    await esp32Characteristic.writeValue(new TextEncoder().encode(codeStr));
    console.log("送信: " + codeStr);
    document.getElementById('status').innerText = "送信済み: " + codeStr;
  } catch (error) {
    console.log(error);
    document.getElementById('status').innerText = "送信失敗";
  }
};
</script>
</body>
</html>
